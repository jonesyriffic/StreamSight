{% extends "base.html" %}

{% block title %}Insight Search Results{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Search Results</h1>
    <div>
        <a href="{{ url_for('library') }}" class="btn btn-outline-info me-2">
            <i class="fas fa-book me-2"></i> Document Library
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i> Dashboard
        </a>
    </div>
</div>

<div class="card bg-dark mb-4">
    <div class="card-body">
        <form action="{{ url_for('search') }}" method="get">
            <div class="input-group">
                <input type="text" name="query" class="form-control" 
                       value="{{ query }}" placeholder="Search term">
                <select name="category" class="form-select" style="max-width: 200px;">
                    <option value="all" {% if selected_category == 'all' %}selected{% endif %}>All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category }}" {% if selected_category == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" type="submit">
                    <i class="fas fa-search me-2"></i> Search
                </button>
            </div>
        </form>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i> {{ error }}
</div>
{% endif %}

{% if results|length == 0 %}
<div class="text-center py-5">
    <div class="card bg-dark p-4">
        <div class="card-body">
            <i class="fas fa-search fa-4x mb-3 text-secondary"></i>
            <h3>No results found</h3>
            <p class="lead">Try different search terms or upload more documents</p>
        </div>
    </div>
</div>
{% else %}
<p class="lead mb-4">Found {{ results|length }} relevant results for "{{ query }}"</p>

{% for result in results %}
<div class="card bg-dark mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <span class="badge 
                {% if result.document.category == 'Industry Insights' %}bg-info
                {% elif result.document.category == 'Technology News' %}bg-success
                {% elif result.document.category == 'Product Management' %}bg-primary
                {% elif result.document.category == 'Customer Service' %}bg-warning
                {% else %}bg-secondary{% endif %}">
                {{ result.document.category }}
            </span>
            <strong class="ms-2">{{ result.document.friendly_name if result.document.friendly_name else result.document.filename }}</strong>
        </div>
        <div>
            <span class="badge bg-secondary">Relevance: {{ result.relevance_score }}/10</span>
            <a href="{{ url_for('view_document', doc_id=result.document.id) }}" class="btn btn-sm btn-info ms-2">
                <i class="fas fa-eye me-1"></i> View Document
            </a>
        </div>
    </div>
    <div class="card-body">
        {% if result.summary %}
        <h5 class="card-title">Summary</h5>
        <p class="card-text mb-4">{{ result.summary }}</p>
        {% endif %}
        
        {% if result.passages %}
        <h5 class="card-title">Key Passages</h5>
        {% set outer_loop = loop %}
        <div class="accordion" id="passages-{{ outer_loop.index }}">
            {% for passage in result.passages %}
            <div class="accordion-item bg-dark-subtle border-secondary">
                <h2 class="accordion-header" id="heading-{{ outer_loop.index }}-{{ loop.index }}">
                    <button class="accordion-button collapsed bg-dark text-light" type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse-{{ outer_loop.index }}-{{ loop.index }}" 
                            aria-expanded="false" 
                            aria-controls="collapse-{{ outer_loop.index }}-{{ loop.index }}">
                        {% if passage.location %}
                        <span class="badge bg-secondary me-2">{{ passage.location }}</span>
                        {% endif %}
                        Relevant Passage {{ loop.index }}
                    </button>
                </h2>
                <div id="collapse-{{ outer_loop.index }}-{{ loop.index }}" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="heading-{{ outer_loop.index }}-{{ loop.index }}" 
                     data-bs-parent="#passages-{{ outer_loop.index }}">
                    <div class="accordion-body">
                        <p class="mb-0">{{ passage.text }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
